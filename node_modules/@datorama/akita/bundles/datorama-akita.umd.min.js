!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@datorama/akita",["exports","rxjs","rxjs/operators"],e):e(((t=t||self).datorama=t.datorama||{},t.datorama.akita={}),t.rxjs,t.rxjs.operators)}(this,(function(t,e,n){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function i(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var o=function(){return(o=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function s(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(s=(o<3?i(s):o>3?i(e,n,s):i(e,n))||s);return o>3&&s&&Object.defineProperty(e,n,s),s}function a(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function u(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function c(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function p(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(c(arguments[e]));return t}var f={type:null,entityIds:null,skip:!1},h=!1;function l(){h=!1}function y(t,e){d(t,e),h=!0}function d(t,e){!1===h&&(f.type=t,f.entityIds=e)}function v(t){void 0===t&&(t=!0),f.skip=t}function g(t,e){return function(n,r,i){var o=i.value;return i.value=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return y(t,e),o.apply(this,n)},i}}function b(t,e){return t.hasOwnProperty(e)}function m(t){var e,n,r=t.state,i=t.entities,s=t.idKey,a=t.options,c=void 0===a?{}:a,f=t.preAddEntity,h={},l=[],y=!1;try{for(var d=u(i),v=d.next();!v.done;v=d.next()){var g=v.value;if(!1===b(r.entities,g[s])){var m=f(g),S=m[s];h[S]=m,c.prepend?l.unshift(S):l.push(S),y=!0}}}catch(t){e={error:t}}finally{try{v&&!v.done&&(n=d.return)&&n.call(d)}finally{if(e)throw e.error}}return y?{newState:o({},r,{entities:o({},r.entities,h),ids:c.prepend?p(l,r.ids):p(r.ids,l)}),newIds:l}:null}function S(t){return null==t}function E(t){return S(t)?[]:Array.isArray(t)?t:[t]}var P;(P=t.EntityActions||(t.EntityActions={})).Set="Set",P.Add="Add",P.Update="Update",P.Remove="Remove";var _="undefined"!=typeof window,A=!_,O=function(){try{return"undefined"!=typeof localStorage}catch(t){return!1}};function w(){return t.__DEV__}function I(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function j(t){return Array.isArray(t)}function C(t,e,n){var r;if(j(t))r=t;else if(I(t)){if(S(n))return;t=Object.assign({wrap:!0},t);var i=e.indexOf(n);if(t.prev){var o=0===i;if(o&&!t.wrap)return;r=o?e[e.length-1]:e[i-1]}else if(t.next){var s=e.length===i+1;if(s&&!t.wrap)return;r=s?e[0]:e[i+1]}}else{if(t===n)return;r=t}return r}t.__DEV__=!0;var k=function(){return{entities:{},ids:[],loading:!0,error:null}};function x(t){return!1===S(t)}function U(t){return!!j(t)&&0===t.length}function N(t){return"function"==typeof t}function F(t){return void 0===t}function V(t){return t.hasOwnProperty("active")}function D(t){return j(t)}function K(t){var e=t.active,n=t.ids,r=t.entities;return D(e)?R(e,n):!1===b(r,e)?null:e}function R(t,e){var n=t.filter((function(t){return e.indexOf(t)>-1}));return n.length===t.length?t:n}function B(t){var e,n,r=t.state,i=t.ids;if(S(i))return M(r);var s=r.entities,a={};try{for(var c=u(r.ids),p=c.next();!p.done;p=c.next()){var f=p.value;!1===i.includes(f)&&(a[f]=s[f])}}catch(t){e={error:t}}finally{try{p&&!p.done&&(n=c.return)&&n.call(c)}finally{if(e)throw e.error}}var h=o({},r,{entities:a,ids:r.ids.filter((function(t){return!1===i.includes(t)}))});return V(r)&&(h.active=K(h)),h}function M(t){return o({},t,{entities:{},ids:[],active:D(t.active)?[]:null})}function H(t,e,n){var r,i,o={entities:{},ids:[]};try{for(var s=u(t),a=s.next();!a.done;a=s.next()){var c=n(a.value);o.entities[c[e]]=c,o.ids.push(c[e])}}catch(t){r={error:t}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(r)throw r.error}}return o}function $(t){return t.entities&&t.ids}function Q(t,e){var n,r,i={};try{for(var o=u(Object.keys(t)),s=o.next();!s.done;s=o.next()){var a=s.value;i[a]=e(t[a])}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return i}function q(t){var e,n,r=t.state,i=t.entities,s=t.idKey,a=t.preAddEntity,u=t.isNativePreAdd;if(j(i)){var c=H(i,s,a);e=c.entities,n=c.ids}else $(i)?(e=u?i.entities:Q(i.entities,a),n=i.ids):(e=u?i:Q(i,a),n=Object.keys(e).map((function(t){return isNaN(t)?t:Number(t)})));var p=o({},r,{entities:e,ids:n,loading:!1});return V(r)&&(p.active=K(p)),p}var L={resettable:!1,ttl:null,producerFn:void 0};function z(){return L}function J(t){Object.freeze(t);var e="function"==typeof t,n=Object.prototype.hasOwnProperty;return Object.getOwnPropertyNames(t).forEach((function(r){!n.call(t,r)||e&&("caller"===r||"callee"===r||"arguments"===r)||null===t[r]||"object"!=typeof t[r]&&"function"!=typeof t[r]||Object.isFrozen(t[r])||J(t[r])})),t}var W=new e.Subject,X=new e.ReplaySubject(50,5e3),Y=new e.Subject;function G(t){W.next(t)}function Z(t){X.next(t)}function tt(t,e){Y.next({storeName:t,action:e})}var et=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e}(Error);function nt(t){return null!=t&&""+t!="false"}function rt(t){return nt(t)&&"Object"===t.constructor.name}var it={},ot={};_&&(window.$$stores=it,window.$$queries=ot);var st=new e.Subject,at=new e.BehaviorSubject(!1),ut={activeTransactions:0,batchTransaction:null};function ct(){ft()||(ut.batchTransaction=new e.Subject),ut.activeTransactions++,at.next(!0)}function pt(){0==--ut.activeTransactions&&(ut.batchTransaction.next(!0),ut.batchTransaction.complete(),at.next(!1),st.next(!0))}function ft(){return ut.activeTransactions>0}function ht(){return ut.batchTransaction?ut.batchTransaction.asObservable():e.of(!0)}function lt(t,e){void 0===e&&(e=void 0),ct();try{return t.apply(e)}finally{y("@Transaction"),pt()}}function yt(){return function(t,e,n){var r=n.value;return n.value=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return lt((function(){return r.apply(t,e)}),this)},n}}var dt=function(){function r(t,n){void 0===n&&(n={}),this.options=n,this.inTransaction=!1,this.cache={active:new e.BehaviorSubject(!1),ttl:null},this.onInit(t)}return r.prototype.setLoading=function(t){void 0===t&&(t=!1),t!==this._value().loading&&(w()&&d("Set Loading"),this._setState((function(e){return o({},e,{loading:t})})))},r.prototype.setHasCache=function(t,e){var n=this;if(void 0===e&&(e={restartTTL:!1}),t!==this.cache.active.value&&this.cache.active.next(t),e.restartTTL){var r=this.getCacheTTL();r&&(null!==this.cache.ttl&&clearTimeout(this.cache.ttl),this.cache.ttl=setTimeout((function(){return n.setHasCache(!1)}),r))}},r.prototype.getValue=function(){return this.storeValue},r.prototype.setError=function(t){t!==this._value().error&&(w()&&d("Set Error"),this._setState((function(e){return o({},e,{error:t})})))},r.prototype._select=function(t){return this.store.asObservable().pipe(n.map((function(e){return t(e.state)})),n.distinctUntilChanged())},r.prototype._value=function(){return this.storeValue},r.prototype._cache=function(){return this.cache.active},Object.defineProperty(r.prototype,"config",{get:function(){return this.constructor.akitaConfig||{}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"storeName",{get:function(){return this.config.storeName||this.options.storeName||this.options.name},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"deepFreeze",{get:function(){return this.config.deepFreezeFn||this.options.deepFreezeFn||J},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"cacheConfig",{get:function(){return this.config.cache||this.options.cache},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"_producerFn",{get:function(){return this.config.producerFn||this.options.producerFn||L.producerFn},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"resettable",{get:function(){return x(this.config.resettable)?this.config.resettable:this.options.resettable},enumerable:!0,configurable:!0}),r.prototype._setState=function(n,r){var i=this;if(void 0===r&&(r=!0),N(n)){var o=n(this._value());this.storeValue=t.__DEV__?this.deepFreeze(o):o}else this.storeValue=n;if(!this.store)return this.store=new e.BehaviorSubject({state:this.storeValue}),void(w()&&this.store.subscribe((function(t){var e=t.action;e&&tt(i.storeName,e)})));ft()?this.handleTransaction():this.dispatch(this.storeValue,r)},r.prototype.reset=function(){var t=this;this.isResettable()?(w()&&d("Reset"),this._setState((function(){return Object.assign({},t._initialState)})),this.setHasCache(!1)):w()&&console.warn("You need to enable the reset functionality")},r.prototype.update=function(t){var e;w()&&d("Update");var n=this._value();e=N(t)?N(this._producerFn)?this._producerFn(n,t):t(n):t;var r=this.akitaPreUpdate(n,o({},n,e)),i=rt(n)?r:new n.constructor(r);this._setState(i)},r.prototype.updateStoreConfig=function(t){this.options=o({},this.options,t)},r.prototype.akitaPreUpdate=function(t,e){return e},r.prototype.ngOnDestroy=function(){this.destroy()},r.prototype.destroy=function(){!!_&&window.hmrEnabled||this!==it[this.storeName]||(delete it[this.storeName],G(this.storeName),this.setHasCache(!1),this.cache.active.complete(),this.store.complete())},r.prototype.onInit=function(t){var e,n;it[this.storeName]=this,this._setState((function(){return t})),Z(this.storeName),this.isResettable()&&(this._initialState=t),w()&&(e=this.storeName,n=this.constructor.name,e||console.error("@StoreConfig({ name }) is missing in "+n))},r.prototype.dispatch=function(t,e){void 0===e&&(e=!0);var n=void 0;e&&(n=f,l()),this.store.next({state:t,action:n})},r.prototype.watchTransaction=function(){var t=this;ht().subscribe((function(){t.inTransaction=!1,t.dispatch(t._value())}))},r.prototype.isResettable=function(){return!1!==this.resettable&&(this.resettable||z().resettable)},r.prototype.handleTransaction=function(){this.inTransaction||(this.watchTransaction(),this.inTransaction=!0)},r.prototype.getCacheTTL=function(){return this.cacheConfig&&this.cacheConfig.ttl||z().ttl},r}();function vt(t){var e,n,r,i=t.state,s=t.ids,a=t.idKey,p=t.newStateOrFn,f=t.preUpdateEntity,h=t.producerFn,l=t.onEntityIdChanges,y={},d=!1;try{for(var v=u(s),g=v.next();!g.done;g=v.next()){var m=g.value;if(!1!==b(i.entities,m)){var S=i.entities[m],E=void 0,P=(E=N(p)?N(h)?h(S,p):p(S):p).hasOwnProperty(a)&&E[a]!==S[a],_=void 0;r=m,P&&(d=!0,r=E[a]);var A=o({},S,E);_=rt(S)?A:rt(E)?new S.constructor(A):new E.constructor(A),y[r]=f(S,_)}}}catch(t){e={error:t}}finally{try{g&&!g.done&&(n=v.return)&&n.call(v)}finally{if(e)throw e.error}}var O=i.ids,w=i.entities;if(d){var I=c(s,1)[0],j=i.entities,C=I;j[C];w=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]])}return n}(j,["symbol"==typeof C?C:C+""]),O=i.ids.map((function(t){return t===I?r:t})),l(I,r)}return o({},i,{entities:o({},w,y),ids:O})}var gt,bt=function(n){function r(t,r){void 0===t&&(t={}),void 0===r&&(r={});var i=n.call(this,o({},{entities:{},ids:[],loading:!0,error:null},t),r)||this;return i.options=r,i.entityActions=new e.Subject,i.entityIdChanges=new e.Subject,i}var c;return i(r,n),Object.defineProperty(r.prototype,"selectEntityAction$",{get:function(){return this.entityActions.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"selectEntityIdChanges$",{get:function(){return this.entityIdChanges.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"idKey",{get:function(){return this.config.idKey||this.options.idKey||"id"},enumerable:!0,configurable:!0}),r.prototype.set=function(e,n){var i=this;if(void 0===n&&(n={}),!S(e)){w()&&d("Set Entity");var o=this.akitaPreAddEntity===r.prototype.akitaPreAddEntity;this.setHasCache(!0,{restartTTL:!0}),this._setState((function(t){var r=q({state:t,entities:e,idKey:i.idKey,preAddEntity:i.akitaPreAddEntity,isNativePreAdd:o});return!1===F(n.activeId)&&(r.active=n.activeId),r})),this.hasInitialUIState()&&this.handleUICreation(),this.entityActions.next({type:t.EntityActions.Set,ids:this.ids})}},r.prototype.add=function(e,n){void 0===n&&(n={loading:!1});var r=E(e);if(!U(r)){var i=m({state:this._value(),preAddEntity:this.akitaPreAddEntity,entities:r,idKey:this.idKey,options:n});i&&(w()&&d("Add Entity"),i.newState.loading=n.loading,this._setState((function(){return i.newState})),this.hasInitialUIState()&&this.handleUICreation(!0),this.entityActions.next({type:t.EntityActions.Add,ids:i.newIds}))}},r.prototype.update=function(e,r){var i=this;if(F(r))n.prototype.update.call(this,e);else{var s,a=[];if(!U(a=N(e)?this.ids.filter((function(t){return e(i.entities[t])})):S(e)?this.ids:E(e)))w()&&d("Update Entity",a),this._setState((function(t){return vt({idKey:i.idKey,ids:a,preUpdateEntity:i.akitaPreUpdateEntity,state:t,newStateOrFn:r,producerFn:i._producerFn,onEntityIdChanges:function(t,e){s={oldId:t,newId:e},i.entityIdChanges.next(o({},s,{pending:!0}))}})})),s&&this.entityIdChanges.next(o({},s,{pending:!1})),this.entityActions.next({type:t.EntityActions.Update,ids:a})}},r.prototype.upsert=function(t,e,n,r){var i=this;void 0===r&&(r={});var s=E(t),a=function(t){return function(e){return b(i.entities,e)===t}},u=N(n)?r.baseClass:n?n.baseClass:void 0,c=N(u),p=s.filter(a(!0)),f=s.filter(a(!1)).map((function(t){var r,s="function"==typeof e?e({}):e,a=N(n)?n(t,s):s,p=o({},a,((r={})[i.idKey]=t,r));return c?new u(p):p}));this.update(p,e),this.add(f),w()&&y("Upsert Entity")},r.prototype.upsertMany=function(e,n){var r,i;void 0===n&&(n={});var s=[],a=[],c={};try{for(var f=u(e),h=f.next();!h.done;h=f.next()){var l=h.value,d=this.akitaPreCheckEntity(l),v=d[this.idKey];if(b(this.entities,v)){var g=this._value().entities[v],m=o({},this._value().entities[v],d),S=n.baseClass?new n.baseClass(m):m,E=(P=this.akitaPreUpdateEntity(g,S))[this.idKey];c[E]=P,a.push(E)}else{var P,_=n.baseClass?new n.baseClass(d):d;E=(P=this.akitaPreAddEntity(_))[this.idKey];s.push(E),c[E]=P}}}catch(t){r={error:t}}finally{try{h&&!h.done&&(i=f.return)&&i.call(f)}finally{if(r)throw r.error}}w()&&y("Upsert Many"),this._setState((function(t){return o({},t,{ids:s.length?p(t.ids,s):t.ids,entities:o({},t.entities,c),loading:!!n.loading})})),a.length&&this.entityActions.next({type:t.EntityActions.Update,ids:a}),s.length&&this.entityActions.next({type:t.EntityActions.Add,ids:s}),s.length&&this.hasUIStore()&&this.handleUICreation(!0)},r.prototype.replace=function(t,e){var n,r,i=E(t);if(!U(i)){var s={};try{for(var a=u(i),c=a.next();!c.done;c=a.next()){var p=c.value;e[this.idKey]=p,s[p]=e}}catch(t){n={error:t}}finally{try{c&&!c.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}w()&&d("Replace Entity",t),this._setState((function(t){return o({},t,{entities:o({},t.entities,s)})}))}},r.prototype.move=function(t,e){var n=this.ids.slice();n.splice(e<0?n.length+e:e,0,n.splice(t,1)[0]),w()&&d("Move Entity"),this._setState((function(t){return o({},t,{entities:o({},t.entities),ids:n})}))},r.prototype.remove=function(e){var n=this;if(!U(this.ids)){var r=x(e),i=[];U(i=N(e)?this.ids.filter((function(t){return e(n.entities[t])})):r?E(e):this.ids)||(w()&&d("Remove Entity",i),this._setState((function(t){return B({state:t,ids:i})})),r||this.setHasCache(!1),this.handleUIRemove(i),this.entityActions.next({type:t.EntityActions.Remove,ids:i}))}},r.prototype.updateActive=function(t){var e=E(this.active);w()&&d("Update Active",e),this.update(e,t)},r.prototype.setActive=function(t){var e=C(t,this.ids,this.active);void 0!==e&&(w()&&d("Set Active",e),this._setActive(e))},r.prototype.addActive=function(t){var e=this,n=E(t);U(n)||(n.every((function(t){return e.active.indexOf(t)>-1}))||(w()&&d("Add Active",t),this._setState((function(t){var e=Array.from(new Set(p(t.active,n)));return o({},t,{active:e})}))))},r.prototype.removeActive=function(t){var e=this,n=E(t);U(n)||n.some((function(t){return e.active.indexOf(t)>-1}))&&(w()&&d("Remove Active",t),this._setState((function(t){return o({},t,{active:Array.isArray(t.active)?t.active.filter((function(t){return-1===n.indexOf(t)})):null})})))},r.prototype.toggleActive=function(t){var e=this,n=E(t),r=function(t){return function(n){return e.active.includes(n)===t}},i=n.filter(r(!0)),o=n.filter(r(!1));this.removeActive(i),this.addActive(o),w()&&y("Toggle Active")},r.prototype.createUIStore=function(t,e){void 0===t&&(t={}),void 0===e&&(e={});var n={name:"UI/"+this.storeName,idKey:this.idKey};return this.ui=new mt(t,o({},n,e)),this.ui},r.prototype.destroy=function(){n.prototype.destroy.call(this),this.ui instanceof r&&this.ui.destroy(),this.entityActions.complete()},r.prototype.akitaPreUpdateEntity=function(t,e){return e},r.prototype.akitaPreAddEntity=function(t){return t},r.prototype.akitaPreCheckEntity=function(t){return t},Object.defineProperty(r.prototype,"ids",{get:function(){return this._value().ids},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"entities",{get:function(){return this._value().entities},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"active",{get:function(){return this._value().active},enumerable:!0,configurable:!0}),r.prototype._setActive=function(t){this._setState((function(e){return o({},e,{active:t})}))},r.prototype.handleUICreation=function(t){var e=this;void 0===t&&(t=!1);var n,r=this.ids,i=N(this.ui._akitaCreateEntityFn),s=function(t){var n,r=e.entities[t],s=i?e.ui._akitaCreateEntityFn(r):e.ui._akitaCreateEntityFn;return o(((n={})[e.idKey]=r[e.idKey],n),s)};n=t?this.ids.filter((function(t){return F(e.ui.entities[t])})).map(s):r.map(s),t?this.ui.add(n):this.ui.set(n)},r.prototype.hasInitialUIState=function(){return this.hasUIStore()&&!1===F(this.ui._akitaCreateEntityFn)},r.prototype.handleUIRemove=function(t){this.hasUIStore()&&this.ui.remove(t)},r.prototype.hasUIStore=function(){return this.ui instanceof mt},s([yt(),a("design:type",Function),a("design:paramtypes",[Object,Object,Object,Object]),a("design:returntype",void 0)],r.prototype,"upsert",null),s([yt(),a("design:type",Function),a("design:paramtypes",["function"==typeof(c="undefined"!=typeof T&&T)?c:Object]),a("design:returntype",void 0)],r.prototype,"toggleActive",null),r}(dt),mt=function(t){function e(e,n){return void 0===e&&(e={}),void 0===n&&(n={}),t.call(this,e,n)||this}return i(e,t),e.prototype.setInitialEntityState=function(t){this._akitaCreateEntityFn=t},e}(bt);function St(t,e,n){var r,i,o,s,a=[];if(N(e))try{for(var c=u(t),p=c.next();!p.done;p=c.next()){!0===e(y=p.value)&&a.push(y)}}catch(t){r={error:t}}finally{try{p&&!p.done&&(i=c.return)&&i.call(c)}finally{if(r)throw r.error}}else{var f=E(e).reduce((function(t,e){return t.add(e)}),new Set);try{for(var h=u(t),l=h.next();!l.done;l=h.next()){var y=l.value;f.has(y[n])&&a.push(y)}}catch(t){o={error:t}}finally{try{l&&!l.done&&(s=h.return)&&s.call(h)}finally{if(o)throw o.error}}}return a}function Et(){return n.distinctUntilChanged((function(t,e){return t===e||!1!==j(t)&&!1!==j(e)&&(!(!U(t)||!U(e))||!Pt(e,t)&&!1===Pt(t,e))}))}function Pt(t,e){return e.some((function(e){return void 0===t.find((function(t){return t===e}))}))}function _t(e,n){return void 0===n&&(n=t.Order.ASC),function(r,i){if(!r.hasOwnProperty(e)||!i.hasOwnProperty(e))return 0;var o="string"==typeof r[e]?r[e].toUpperCase():r[e],s="string"==typeof i[e]?i[e].toUpperCase():i[e],a=0;return o>s?a=1:o<s&&(a=-1),n==t.Order.DESC?-1*a:a}}function At(t,e){for(var n=[],r=t.ids,i=t.entities,o=e.filterBy,s=e.limitTo,a=e.sortBy,u=e.sortByOrder,c=function(t){var e=i[r[t]];if(!o)return n.push(e),"continue";E(o).every((function(n){return n(e,t)}))&&n.push(e)},p=0;p<r.length;p++)c(p);if(a){var f=N(a)?a:_t(a,u);n=n.sort((function(e,n){return f(e,n,t)}))}var h=Math.min(s||n.length,n.length);return h===n.length?n:n.slice(0,h)}function Ot(t,e){var n={},r=e.filterBy,i=e.limitTo,o=t.ids,s=t.entities;if(!r&&!i)return s;var a=!1===S(i);if(r&&a)for(var u=0,c=function(t,e){if(u===i)return"break";var a=o[t],c=s[a];E(r).every((function(e){return e(c,t)}))&&(n[a]=c,u++)},p=0,f=o.length;p<f;p++){if("break"===c(p))break}else{var h=Math.min(i||o.length,o.length),l=function(t){var e=o[t],i=s[e];if(!r)return n[e]=i,"continue";E(r).every((function(e){return e(i,t)}))&&(n[e]=i)};for(p=0;p<h;p++)l(p)}return n}function wt(t){return"string"==typeof t}function It(t,e){return function(n){var r=n[t];if(!F(r))return e?wt(e)?r[e]:e(r):r}}(gt=t.Order||(t.Order={})).ASC="asc",gt.DESC="desc";var jt=function(){function t(t){this.store=t,this.__store__=t,w()&&(ot[t.storeName]=this)}return t.prototype.select=function(t){var e,r;if(N(t))e=t;else if(wt(t))e=function(e){return e[t]};else{if(Array.isArray(t))return this.store._select((function(t){return t})).pipe(n.distinctUntilChanged((r=t,function(t,e){var n=N(r[0]);return!1===r.some((function(r){return n?r(t)!==r(e):t[r]!==e[r]}))})),n.map((function(e){return N(t[0])?t.map((function(t){return t(e)})):t.reduce((function(t,n){return t[n]=e[n],t}),{})})));e=function(t){return t}}return this.store._select(e)},t.prototype.selectLoading=function(){return this.select((function(t){return t.loading}))},t.prototype.selectError=function(){return this.select((function(t){return t.error}))},t.prototype.getValue=function(){return this.store._value()},t.prototype.selectHasCache=function(){return this.store._cache().asObservable()},t.prototype.getHasCache=function(){return this.store._cache().value},Object.defineProperty(t.prototype,"config",{get:function(){return this.constructor.akitaQueryConfig},enumerable:!0,configurable:!0}),t}();function Ct(t,e){t.sortBy=t.sortBy||e&&e.sortBy,t.sortByOrder=t.sortByOrder||e&&e.sortByOrder}var kt=function(t){function r(e,n){void 0===n&&(n={});var r=t.call(this,e)||this;return r.options=n,r.__store__=e,r}return i(r,t),r.prototype.selectAll=function(t){var e=this;return void 0===t&&(t={asObject:!1}),this.select((function(t){return t.entities})).pipe(n.map((function(){return e.getAll(t)})))},r.prototype.getAll=function(t){return void 0===t&&(t={asObject:!1,filterBy:void 0,limitTo:void 0}),t.asObject?Ot(this.getValue(),t):(Ct(t,this.config||this.options),At(this.getValue(),t))},r.prototype.selectMany=function(t,r){return t&&t.length?this.select((function(t){return t.entities})).pipe(n.map((function(e){return n=function(t){return It(t,r)(e)},t.reduce((function(t,e,r,i){var o=n(e,r,i);return void 0!==o&&t.push(o),t}),[]);var n})),Et()):e.of([])},r.prototype.selectEntity=function(t,e){var r=t;return N(t)&&(r=function(t,e){var n,r;try{for(var i=u(Object.keys(e)),o=i.next();!o.done;o=i.next()){var s=o.value;if(!0===t(e[s]))return s}}catch(t){n={error:t}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}}(t,this.getValue().entities)),this.select((function(t){return t.entities})).pipe(n.map(It(r,e)),n.distinctUntilChanged())},r.prototype.getEntity=function(t){return this.getValue().entities[t]},r.prototype.selectActiveId=function(){return this.select((function(t){return t.active}))},r.prototype.getActiveId=function(){return this.getValue().active},r.prototype.selectActive=function(t){var e=this;return j(this.getActive())?this.selectActiveId().pipe(n.switchMap((function(n){return e.selectMany(n,t)}))):this.selectActiveId().pipe(n.switchMap((function(n){return e.selectEntity(n,t)})))},r.prototype.getActive=function(){var t=this,e=this.getActiveId();return j(e)?e.map((function(e){return t.getValue().entities[e]})):nt(e)?this.getEntity(e):void 0},r.prototype.selectCount=function(t){var e=this;return this.select((function(t){return t.entities})).pipe(n.map((function(){return e.getCount(t)})))},r.prototype.getCount=function(t){return N(t)?this.getAll().filter(t).length:this.getValue().ids.length},r.prototype.selectLast=function(t){return this.selectAt((function(t){return t[t.length-1]}),t)},r.prototype.selectFirst=function(t){return this.selectAt((function(t){return t[0]}),t)},r.prototype.selectEntityAction=function(t){if(S(t))return this.store.selectEntityAction$;var e=j(t)?function(t){return t}:function(t){return t.ids},r=E(t);return this.store.selectEntityAction$.pipe(n.filter((function(t){var e=t.type;return r.includes(e)})),n.map((function(t){return e(t)})))},r.prototype.hasEntity=function(t){var e=this;return S(t)?this.getValue().ids.length>0:N(t)?this.getAll().some(t):j(t)?t.every((function(t){return t in e.getValue().entities})):t in this.getValue().entities},r.prototype.hasActive=function(t){var e=this.getValue().active,n=x(t);return Array.isArray(e)?n?e.includes(t):e.length>0:n?e===t:x(e)},r.prototype.createUIQuery=function(){this.ui=new xt(this.__store__.ui)},r.prototype.selectAt=function(t,e){var r=this;return this.select((function(t){return t.ids})).pipe(n.map(t),n.distinctUntilChanged(),n.switchMap((function(t){return r.selectEntity(t,e)})))},r}(jt),xt=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e}(kt),Tt=function(t){return t.pipe(n.filter((function(t){return null!=t})))};function Ut(t,e){return 1===e.split(".").length?t:e.split(".").slice(1).join(".").split(".").reduce((function(t,e){return t&&t[e]}),t)}function Nt(t,e,n){var r=e.split(".");if(1===r.length)return o({},t,n);t=o({},t);var i=r.length-2;return e.split(".").slice(1).reduce((function(t,e,r){return r!==i?(t[e]=o({},t[e]),t&&t[e]):(t[e]=Array.isArray(t[e])||!I(t[e])?n:o({},t[e],n),t&&t[e])}),t),t}var Ft=!1,Vt=new e.ReplaySubject(1);function Dt(t){Ft=t}function Kt(){return Ft}function Rt(t){return(n=t)&&N(n.then)||e.isObservable(t)?e.from(t):e.of(t);var n}var Bt=function(){function t(){}return t.prototype.getStoresSnapshot=function(t){void 0===t&&(t=[]);for(var e={},n=t.length>0?t:Object.keys(it),r=0;r<n.length;r++){var i=n[r];"router"!==i&&(e[i]=it[i]._value())}return e},t.prototype.setStoresSnapshot=function(t,e){var r=o({skipStorageUpdate:!1,lazy:!1},e);r.skipStorageUpdate&&Dt(!0);var i=t;wt(t)&&(i=JSON.parse(i));var s=Object.keys(i).length;if(r.lazy)X.pipe(n.filter((function(t){return i.hasOwnProperty(t)})),n.take(s)).subscribe((function(t){return it[t]._setState((function(){return i[t]}))}));else for(var a=function(t,e){var n=e[t];it[n]&&it[n]._setState((function(){return i[n]}))},u=0,c=Object.keys(i);u<c.length;u++)a(u,c);r.skipStorageUpdate&&Dt(!1)},t}(),Mt=new Bt,Ht=function(){function t(t,e){this.query=t,e&&e.resetFn&&z().resettable&&this.onReset(e.resetFn)}return t.prototype.getQuery=function(){return this.query},t.prototype.getStore=function(){return this.getQuery().__store__},t.prototype.isEntityBased=function(t){return nt(t)},t.prototype.selectSource=function(t,e){var n=this;return this.isEntityBased(t)?this.getQuery().selectEntity(t).pipe(Tt):e?this.getQuery().select((function(t){return Ut(t,n.withStoreName(e))})):this.getQuery().select()},t.prototype.getSource=function(t,e){if(this.isEntityBased(t))return this.getQuery().getEntity(t);var n=this.getQuery().getValue();return e?Ut(n,this.withStoreName(e)):n},t.prototype.withStoreName=function(t){return this.storeName+"."+t},Object.defineProperty(t.prototype,"storeName",{get:function(){return this.getStore().storeName},enumerable:!0,configurable:!0}),t.prototype.updateStore=function(t,e,n){var r=this;if(this.isEntityBased(e))this.getStore().update(e,t);else{if(n)return void this.getStore()._setState((function(e){return Nt(e,r.withStoreName(n),t)}));this.getStore()._setState((function(e){return o({},e,t)}))}},t.prototype.onReset=function(t){var e=this,n=this.getStore().reset;this.getStore().reset=function(){for(var r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];setTimeout((function(){n.apply(e.getStore(),r),t()}))}},t}(),$t={pagesControls:!1,range:!1,startWith:1,cacheTimeout:void 0,clearStoreWithCache:!0},Qt=function(t){function r(r,i){void 0===i&&(i={});var o=t.call(this,r,{resetFn:function(){o.initial=!1,o.destroy({clearCache:!0,currentPage:1})}})||this;o.query=r,o.config=i,o.metadata=new Map,o.pages=new Map,o.pagination={currentPage:1,perPage:0,total:0,lastPage:0,data:[]},o.initial=!0,o.isLoading$=o.query.selectLoading().pipe(n.delay(0)),o.config=Object.assign($t,i);var s=o.config,a=s.startWith,u=s.cacheTimeout;return o.page=new e.BehaviorSubject(a),e.isObservable(u)&&(o.clearCacheSubscription=u.subscribe((function(){return o.clearCache()}))),o}return i(r,t),Object.defineProperty(r.prototype,"pageChanges",{get:function(){return this.page.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"currentPage",{get:function(){return this.pagination.currentPage},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isFirst",{get:function(){return 1===this.currentPage},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isLast",{get:function(){return this.currentPage===this.pagination.lastPage},enumerable:!0,configurable:!0}),r.prototype.withControls=function(){return this.config.pagesControls=!0,this},r.prototype.withRange=function(){return this.config.range=!0,this},r.prototype.setLoading=function(t){void 0===t&&(t=!0),this.getStore().setLoading(t)},r.prototype.update=function(t){this.pagination=t,this.addPage(t.data)},r.prototype.addPage=function(t){var e=this;this.pages.set(this.currentPage,{ids:t.map((function(t){return t[e.getStore().idKey]}))}),this.getStore().upsertMany(t)},r.prototype.clearCache=function(t){void 0===t&&(t={}),this.initial||(y("@Pagination - Clear Cache"),!1!==t.clearStore&&(this.config.clearStoreWithCache||t.clearStore)&&this.getStore().remove(),this.pages=new Map,this.metadata=new Map),this.initial=!1},r.prototype.clearPage=function(t){this.pages.delete(t)},r.prototype.destroy=function(t){var e=void 0===t?{}:t,n=e.clearCache,r=e.currentPage;this.clearCacheSubscription&&this.clearCacheSubscription.unsubscribe(),n&&this.clearCache(),F(r)||this.setPage(r),this.initial=!0},r.prototype.isPageActive=function(t){return this.currentPage===t},r.prototype.setPage=function(t){t===this.currentPage&&this.hasPage(t)||this.page.next(this.pagination.currentPage=t)},r.prototype.nextPage=function(){this.currentPage!==this.pagination.lastPage&&this.setPage(this.pagination.currentPage+1)},r.prototype.prevPage=function(){this.pagination.currentPage>1&&this.setPage(this.pagination.currentPage-1)},r.prototype.setLastPage=function(){this.setPage(this.pagination.lastPage)},r.prototype.setFirstPage=function(){this.setPage(1)},r.prototype.hasPage=function(t){return this.pages.has(t)},r.prototype.getPage=function(t){var r=this,i=this.pagination.currentPage;return this.hasPage(i)?this.selectPage(i):(this.setLoading(!0),e.from(t()).pipe(n.switchMap((function(t){return i=t.currentPage,lt((function(){r.setLoading(!1),r.update(t)})),r.selectPage(i)}))))},r.prototype.getQuery=function(){return this.query},r.prototype.refreshCurrentPage=function(){!1===S(this.currentPage)&&(this.clearPage(this.currentPage),this.setPage(this.currentPage))},r.prototype.getFrom=function(){return this.isFirst?1:(this.currentPage-1)*this.pagination.perPage+1},r.prototype.getTo=function(){return this.isLast?this.pagination.total:this.currentPage*this.pagination.perPage},r.prototype.selectPage=function(t){var e=this;return this.query.selectAll({asObject:!0}).pipe(n.take(1),n.map((function(n){var r=o({},e.pagination,{data:e.pages.get(t).ids.map((function(t){return n[t]}))}),i=e.config,s=i.range,a=i.pagesControls;return isNaN(e.pagination.total)&&(1===r.lastPage?r.total=r.data?r.data.length:0:r.total=r.perPage*r.lastPage,e.pagination.total=r.total),s&&(r.from=e.getFrom(),r.to=e.getTo()),a&&(r.pageControls=function(t,e){for(var n=Math.ceil(t/e),r=[],i=0;i<n;i++)r.push(i+1);return r}(e.pagination.total,e.pagination.perPage)),r})))},s([g("@Pagination - New Page"),a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],r.prototype,"update",null),r}(Ht);var qt=Qt,Lt=function(t){function e(e,n,r){void 0===r&&(r={});var i=t.call(this,e)||this;return i.query=e,i.factoryFnOrPath=n,i.params=r,i.params=o({debounceTime:300,formKey:"akitaForm",emitEvent:!1,arrControlFactory:function(t){return i.builder.control(t)}},r),i.isRootKeys=!1===nt(n),i.isKeyBased=wt(n)||i.isRootKeys,i}return i(e,t),e.prototype.setForm=function(t,e){return this.form=t,this.builder=e,this.activate(),this},e.prototype.reset=function(t){var e,n,r=this;n=t||(this.isKeyBased?this.initialValue:this.factoryFnOrPath()),this.isKeyBased&&Object.keys(this.initialValue).forEach((function(t){var e=r.initialValue[t];if(Array.isArray(e)&&r.builder){var n=r.form.controls[t];r.cleanArray(n),e.forEach((function(e,n){r.form.get(t).insert(n,r.params.arrControlFactory(e))}))}})),this.form.patchValue(n,{emitEvent:this.params.emitEvent});var i=this.isKeyBased?Nt(this.getQuery().getValue(),this.getStore().storeName+"."+this.factoryFnOrPath,n):((e={})[this.params.formKey]=n,e);this.updateStore(i)},e.prototype.cleanArray=function(t){for(;0!==t.length;)t.removeAt(0)},e.prototype.resolveInitialValue=function(t,e){var n=this;if(t)return Object.keys(t).reduce((function(t,r){var i=e[r];if(Array.isArray(i)&&n.builder){var o=n.params.arrControlFactory;n.cleanArray(n.form.get(r)),i.forEach((function(t,e){n.form.get(r).insert(e,o(t))}))}return t[r]=e[r],t}),{})},e.prototype.activate=function(){var t,e,r=this;if(this.isKeyBased)if(this.isRootKeys)this.initialValue=this.resolveInitialValue(this.form.value,this.getQuery().getValue()),this.form.patchValue(this.initialValue,{emitEvent:this.params.emitEvent});else{e=this.getStore().storeName+"."+this.factoryFnOrPath;var i=Ut(this.getQuery().getValue(),e);this.initialValue=this.resolveInitialValue(i,i),this.form.patchValue(this.initialValue,{emitEvent:this.params.emitEvent})}else{this.getQuery().getValue()[this.params.formKey]||(y("@PersistNgFormPlugin activate"),this.updateStore(((t={})[this.params.formKey]=this.factoryFnOrPath(),t)));var s=this.getQuery().getValue()[this.params.formKey];this.form.patchValue(s)}this.formChanges=this.form.valueChanges.pipe(n.debounceTime(this.params.debounceTime)).subscribe((function(t){var n;y("@PersistForm - Update"),n=r.isKeyBased?r.isRootKeys?function(e){return o({},e,t)}:function(n){return Nt(n,e,t)}:function(){var e;return(e={})[r.params.formKey]=t,e},r.updateStore(n(r.getQuery().getValue()))}))},e.prototype.destroy=function(){this.formChanges&&this.formChanges.unsubscribe(),this.form=null,this.builder=null},e}(Ht);function zt(t){return t&&t.charAt(0).toUpperCase()+t.slice(1)}var Jt=[];var Wt=function(){function t(t,e){this.query=t,this.entityIds=e,this.entities=new Map}return t.prototype.getEntity=function(t){return this.entities.get(t)},t.prototype.hasEntity=function(t){return this.entities.has(t)},t.prototype.removeEntity=function(t){return this.destroy(t),this.entities.delete(t)},t.prototype.createEntity=function(t,e){return this.entities.set(t,e)},t.prototype.getIds=function(){return F(this.entityIds)?this.query.getValue().ids:E(this.entityIds)},t.prototype.resolvedIds=function(t){return F(t)?this.getIds():E(t)},t.prototype.rebase=function(t,e){var n=this;if(void 0===e&&(e={}),nt(t))if(F(this.entityIds)){for(var r=0,i=t.length;r<i;r++){var o=t[r];if(!1===this.hasEntity(o)){N(e.beforeAdd)&&e.beforeAdd(o);var s=this.instantiatePlugin(o);this.entities.set(o,s),N(e.afterAdd)&&e.afterAdd(s)}}this.entities.forEach((function(r,i){-1===t.indexOf(i)&&(N(e.beforeRemove)&&e.beforeRemove(r),n.removeEntity(i))}))}else{var a=E(this.entityIds);for(r=0,i=a.length;r<i;r++){o=a[r];if(t.indexOf(o)>-1&&!1===this.hasEntity(o)){N(e.beforeAdd)&&e.beforeAdd(o);s=this.instantiatePlugin(o);this.entities.set(o,s),N(e.afterAdd)&&e.afterAdd(s)}else this.entities.forEach((function(r,i){-1===t.indexOf(i)&&!0===n.hasEntity(i)&&(N(e.beforeRemove)&&e.beforeRemove(r),n.removeEntity(i))}))}}else this.getIds().forEach((function(t){n.hasEntity(t)||n.createEntity(t,n.instantiatePlugin(t))}))},t.prototype.selectIds=function(){return this.query.select((function(t){return t.ids}))},t.prototype.activate=function(t){this.rebase(t)},t.prototype.forEachId=function(t,e){for(var n=this.resolvedIds(t),r=0,i=n.length;r<i;r++){var o=n[r];this.hasEntity(o)&&e(this.getEntity(o))}},t}(),Xt=function(t){function r(e,n,r){void 0===n&&(n={});var i=t.call(this,e,{resetFn:function(){return i.clear()}})||this;return i.query=e,i.params=n,i._entityId=r,i.skip=!1,i.history={past:[],present:null,future:[]},i.skipUpdate=!1,n.maxAge=n.maxAge?n.maxAge:10,n.comparator=n.comparator||function(){return!0},i.activate(),i}return i(r,t),Object.defineProperty(r.prototype,"hasPast$",{get:function(){return this._hasPast$},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"hasFuture$",{get:function(){return this._hasFuture$},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"hasPast",{get:function(){return this.history.past.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"hasFuture",{get:function(){return this.history.future.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"property",{get:function(){return this.params.watchProperty},enumerable:!0,configurable:!0}),r.prototype.updateHasHistory=function(){this.hasFutureSubject.next(this.hasFuture),this.hasPastSubject.next(this.hasPast)},r.prototype.activate=function(){var t=this;this.hasPastSubject=new e.BehaviorSubject(!1),this._hasPast$=this.hasPastSubject.asObservable().pipe(n.distinctUntilChanged()),this.hasFutureSubject=new e.BehaviorSubject(!1),this._hasFuture$=this.hasFutureSubject.asObservable().pipe(n.distinctUntilChanged()),this.history.present=this.getSource(this._entityId,this.property),this.subscription=this.selectSource(this._entityId,this.property).pipe(n.pairwise()).subscribe((function(e){var n=c(e,2),r=n[0],i=n[1];if(t.skip)t.skip=!1;else{var o=t.params.comparator(r,i);!t.skipUpdate&&o&&(t.history.past.length===t.params.maxAge&&(t.history.past=t.history.past.slice(1)),t.history.past=p(t.history.past,[r]),t.history.present=i,t.updateHasHistory())}}))},r.prototype.undo=function(){if(this.history.past.length>0){var t=this.history,e=t.past,n=t.present,r=e[e.length-1];this.history.past=e.slice(0,e.length-1),this.history.present=r,this.history.future=p([n],this.history.future),this.update()}},r.prototype.redo=function(){if(this.history.future.length>0){var t=this.history,e=t.past,n=t.present,r=this.history.future[0],i=this.history.future.slice(1);this.history.past=p(e,[n]),this.history.present=r,this.history.future=i,this.update("Redo")}},r.prototype.jumpToPast=function(t){if(!(t<0||t>=this.history.past.length)){var e=this.history,n=e.past,r=e.future,i=e.present,o=n.slice(0,t),s=p(n.slice(t+1),[i],r),a=n[t];this.history.past=o,this.history.present=a,this.history.future=s,this.update()}},r.prototype.jumpToFuture=function(t){if(!(t<0||t>=this.history.future.length)){var e=this.history,n=e.past,r=e.future,i=p(n,[e.present],r.slice(0,t)),o=r[t],s=r.slice(t+1);this.history.past=i,this.history.present=o,this.history.future=s,this.update("Redo")}},r.prototype.jump=function(t){return t>0?this.jumpToFuture(t-1):t<0?this.jumpToPast(this.history.past.length+t):void 0},r.prototype.clear=function(t){this.history=N(t)?t(this.history):{past:[],present:null,future:[]},this.updateHasHistory()},r.prototype.destroy=function(t){void 0===t&&(t=!1),t&&this.clear(),this.subscription.unsubscribe()},r.prototype.ignoreNext=function(){this.skip=!0},r.prototype.update=function(t){void 0===t&&(t="Undo"),this.skipUpdate=!0,y("@StateHistory - "+t),this.updateStore(this.history.present,this._entityId,this.property),this.updateHasHistory(),this.skipUpdate=!1},r}(Ht),Yt=function(t){function e(e,r){void 0===r&&(r={});var i=t.call(this,e,r.entityIds)||this;return i.query=e,i.params=r,r.maxAge=nt(r.maxAge)?r.maxAge:10,i.activate(),i.selectIds().pipe(n.skip(1)).subscribe((function(t){return i.activate(t)})),i}return i(e,t),e.prototype.redo=function(t){this.forEachId(t,(function(t){return t.redo()}))},e.prototype.undo=function(t){this.forEachId(t,(function(t){return t.undo()}))},e.prototype.hasPast=function(t){if(this.hasEntity(t))return this.getEntity(t).hasPast},e.prototype.hasFuture=function(t){if(this.hasEntity(t))return this.getEntity(t).hasFuture},e.prototype.jumpToFuture=function(t,e){this.forEachId(t,(function(t){return t.jumpToFuture(e)}))},e.prototype.jumpToPast=function(t,e){this.forEachId(t,(function(t){return t.jumpToPast(e)}))},e.prototype.clear=function(t){this.forEachId(t,(function(t){return t.clear()}))},e.prototype.destroy=function(t,e){void 0===e&&(e=!1),this.forEachId(t,(function(t){return t.destroy(e)}))},e.prototype.ignoreNext=function(t){this.forEachId(t,(function(t){return t.ignoreNext()}))},e.prototype.instantiatePlugin=function(t){return new Xt(this.query,this.params,t)},e}(Wt),Gt={comparator:function(t,e){return JSON.stringify(t)!==JSON.stringify(e)}};function Zt(t,e){return e.split(".").reduce((function(t,e){return t&&"undefined"!==t[e]?t[e]:void 0}),t)}var te,ee,ne=function(t){function r(r,i,s){var a=t.call(this,r)||this;if(a.query=r,a.params=i,a._entityId=s,a.dirty=new e.BehaviorSubject(!1),a.active=!1,a._reset=new e.Subject,a.isDirty$=a.dirty.asObservable().pipe(n.distinctUntilChanged()),a.reset$=a._reset.asObservable(),a.params=o({},Gt,i),a.params.watchProperty){var u=E(a.params.watchProperty);r instanceof kt&&u.includes("entities")&&!u.includes("ids")&&u.push("ids"),a.params.watchProperty=u}return a}return i(r,t),r.prototype.reset=function(t){void 0===t&&(t={});var e=this.head;N(t.updateFn)&&(e=this.isEntityBased(this._entityId)?t.updateFn(this.head,this.getQuery().getEntity(this._entityId)):t.updateFn(this.head,this.getQuery().getValue())),y("@DirtyCheck - Revert"),this.updateStore(e,this._entityId),this._reset.next()},r.prototype.setHead=function(){return this.active?this.head=this._getHead():(this.activate(),this.active=!0),this.updateDirtiness(!1),this},r.prototype.isDirty=function(){return!!this.dirty.value},r.prototype.hasHead=function(){return!!this.getHead()},r.prototype.destroy=function(){this.head=null,this.subscription&&this.subscription.unsubscribe(),this._reset&&this._reset.complete()},r.prototype.isPathDirty=function(t){var e=this.getHead(),n=Zt(this.getQuery().getValue(),t),r=Zt(e,t);return this.params.comparator(n,r)},r.prototype.getHead=function(){return this.head},r.prototype.activate=function(){var t=this;this.head=this._getHead();var r=this.params.watchProperty?this.params.watchProperty.map((function(e){return t.query.select((function(t){return t[e]})).pipe(n.map((function(t){return{val:t,__akitaKey:e}})))})):[this.selectSource(this._entityId)];this.subscription=e.combineLatest.apply(void 0,p(r)).pipe(n.skip(1)).subscribe((function(e){if(!F(t.head)){var n=e.some((function(e){var n=e.__akitaKey?t.head[e.__akitaKey]:t.head,r=e.__akitaKey?e.val:e;return t.params.comparator(n,r)}));t.updateDirtiness(n)}}))},r.prototype.updateDirtiness=function(t){this.dirty.next(t)},r.prototype._getHead=function(){var t=this.getSource(this._entityId);return this.params.watchProperty&&(t=this.getWatchedValues(t)),t},r.prototype.getWatchedValues=function(t){return this.params.watchProperty.reduce((function(e,n){return e[n]=t[n],e}),{})},r}(Ht),re=function(t){function r(r,i){void 0===i&&(i={});var s=t.call(this,r,i.entityIds)||this;return s.query=r,s.params=i,s._someDirty=new e.Subject,s.someDirty$=e.merge(s.query.select((function(t){return t.entities})),s._someDirty.asObservable()).pipe(n.auditTime(0),n.map((function(){return s.checkSomeDirty()}))),s.params=o({},Gt,i),s.activate(),s.selectIds().pipe(n.skip(1)).subscribe((function(e){t.prototype.rebase.call(s,e,{afterAdd:function(t){return t.setHead()}})})),s}return i(r,t),r.prototype.setHead=function(t){if(this.params.entityIds&&t){var e=E(t);if(!1===E(this.params.entityIds).some((function(t){return e.indexOf(t)>-1})))return this}return this.forEachId(t,(function(t){return t.setHead()})),this._someDirty.next(),this},r.prototype.hasHead=function(t){return!!this.entities.has(t)&&this.getEntity(t).hasHead()},r.prototype.reset=function(t,e){void 0===e&&(e={}),this.forEachId(t,(function(t){return t.reset(e)}))},r.prototype.isDirty=function(t,e){if(void 0===e&&(e=!0),this.entities.has(t)){var n=this.getEntity(t);return e?n.isDirty$:n.isDirty()}return!1},r.prototype.someDirty=function(){return this.checkSomeDirty()},r.prototype.isPathDirty=function(t,e){if(this.entities.has(t)){var n=this.getEntity(t).getHead(),r=Zt(this.query.getEntity(t),e),i=Zt(n,e);return this.params.comparator(r,i)}return null},r.prototype.destroy=function(t){this.forEachId(t,(function(t){return t.destroy()})),t||this._someDirty.complete()},r.prototype.instantiatePlugin=function(t){return new ne(this.query,this.params,t)},r.prototype.checkSomeDirty=function(){var t,e,n=this.resolvedIds();try{for(var r=u(n),i=r.next();!i.done;i=r.next()){var o=i.value;if(this.getEntity(o).isDirty())return!0}}catch(e){t={error:e}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return!1},r}(Wt);(t.StoreAction||(t.StoreAction={})).Update="UPDATE";var ie,oe=((te={})[t.StoreAction.Update]="update",te);(ie=t.EntityStoreAction||(t.EntityStoreAction={})).Update="UPDATE",ie.AddEntities="ADD_ENTITIES",ie.SetEntities="SET_ENTITIES",ie.UpdateEntities="UPDATE_ENTITIES",ie.RemoveEntities="REMOVE_ENTITIES",ie.UpsertEntities="UPSERT_ENTITIES",ie.UpsertManyEntities="UPSERT_MANY_ENTITIES";var se=((ee={})[t.EntityStoreAction.Update]="update",ee[t.EntityStoreAction.AddEntities]="add",ee[t.EntityStoreAction.SetEntities]="set",ee[t.EntityStoreAction.UpdateEntities]="update",ee[t.EntityStoreAction.RemoveEntities]="remove",ee[t.EntityStoreAction.UpsertEntities]="upsert",ee[t.EntityStoreAction.UpsertManyEntities]="upsertMany",ee);function ae(t){return ue(t.akitaConfig.storeName)}function ue(t){var e=it[t];if(S(e))throw new et(e+" doesn't exist");return e}function ce(t){return ae(t)}function pe(t){return ue(t)}function fe(t,e,n,r){var i;if(void 0===r&&(r="id"),N(e))i=e;else{var s=E(e);i=function(t){return!0===s.includes(I(t)?t[r]:t)}}return t.map((function(t,e){return!0===i(t,e)?I(t)?o({},t,n):n:t}))}function he(t,e,n){void 0===n&&(n={});var r=E(e),i=t||[];return n.prepend?p(r,i):p(i,r)}function le(t){return function(e,n){return e[t]===n[t]}}var ye=function(){};var de=function(){function t(t){this.query=t}return t.prototype.call=function(t,r){var i=this;return r.pipe(n.first(),n.switchMap((function(t){var r=t[i.query.__store__.config.idKey],o=!1;return e.merge(e.of({newId:void 0,oldId:r,pending:!1}),i.query.__store__.selectEntityIdChanges$).pipe(n.filter((function(t){return t.oldId===r})),n.tap((function(t){return o=t.pending})),n.filter((function(t){return t.newId!==r&&!o})),n.switchMap((function(t){return i.query.selectEntity(r=t.newId||r).pipe(n.filter((function(){return!o})))})))}))).subscribe(t)},t}();t.$$addStore=X,t.$$deleteStore=W,t.$$updateStore=Y,t.AkitaPlugin=Ht,t.DEFAULT_ID_KEY="id",t.DirtyCheckPlugin=ne,t.EntityCollectionPlugin=Wt,t.EntityDirtyCheckPlugin=re,t.EntityService=ye,t.EntityStateHistoryPlugin=Yt,t.EntityStore=bt,t.EntityUIQuery=xt,t.EntityUIStore=mt,t.Paginator=qt,t.PaginatorPlugin=Qt,t.PersistNgFormPlugin=Lt,t.Query=jt,t.QueryConfig=function(t){return function(e){e.akitaQueryConfig={};for(var n=0,r=Object.keys(t);n<r.length;n++){var i=r[n];e.akitaQueryConfig[i]=t[i]}}},t.QueryEntity=kt,t.SnapshotManager=Bt,t.StateHistoryPlugin=Xt,t.Store=dt,t.StoreConfig=function(t){return function(e){e.akitaConfig={idKey:"id"};for(var n=0,r=Object.keys(t);n<r.length;n++){var i=r[n];"name"===i?e.akitaConfig.storeName=t[i]:e.akitaConfig[i]=t[i]}}},t.__stores__=it,t.action=g,t.addEntities=m,t.akitaConfig=function(t){L=o({},L,t)},t.akitaDevtools=function(t,e){if(void 0===e&&(e={}),!A&&window.__REDUX_DEVTOOLS_EXTENSION__){Jt.length&&Jt.forEach((function(t){t.unsubscribe?t.unsubscribe():t&&t()})),t&&t.run||((t=t||{}).run=function(t){return t()},e=t);var n=Object.assign({},{name:"Akita",shallow:!0,storesWhitelist:[]},e),r=n.storesWhitelist,i=window.__REDUX_DEVTOOLS_EXTENSION__.connect(n),s={},a=function(t){return!r.length||r.indexOf(t)>-1};Jt.push(X.subscribe((function(t){var e;!1!==a(t)&&(s=o({},s,((e={})[t]=it[t]._value(),e)),i.send({type:"["+zt(t)+"] - @@INIT"},s))}))),Jt.push(W.subscribe((function(t){!1!==a(t)&&(delete s[t],i.send({type:"["+t+"] - Delete Store"},s))}))),Jt.push(Y.subscribe((function(t){var n,r=t.storeName,u=t.action;if(!1!==a(r)){var c=u.type,p=u.entityIds;if(u.skip)v(!1);else{var f=it[r];if(f){if(!1===e.shallow&&s[r])if(JSON.stringify(f._value())===JSON.stringify(s[r]))return;s=o({},s,((n={})[r]=f._value(),n));var h=zt(r),l=x(p)?"["+h+"] - "+c+" (ids: "+p+")":"["+h+"] - "+c;if(e.logTrace&&(console.group(l),console.trace(),console.groupEnd()),e.sortAlphabetically){var y=Object.keys(s).sort().reduce((function(t,e){return t[e]=s[e],t}),{});i.send({type:l},y)}else i.send({type:l},s)}}}}))),Jt.push(i.subscribe((function(e){if("DISPATCH"===e.type){if("COMMIT"===e.payload.type)return void i.init(s);if(e.state)for(var n=JSON.parse(e.state),r=function(e,r){var i=r[e];it[i]&&t.run((function(){it[i]._setState((function(){return n[i]}),!1)}))},o=0,a=Object.keys(n);o<a.length;o++)r(o,a)}})))}},t.applyTransaction=lt,t.arrayAdd=he,t.arrayFind=function(t,e){return function(r){return r.pipe(n.map((function(n){return!1===j(n)?n:St(n,t,e||"id")})),Et(),n.map((function(e){return!1===j(e)||j(t)||N(t)?e:e[0]})))}},t.arrayRemove=function(t,e,n){var r,i,o;if(void 0===n&&(n="id"),N(e)?(o=e,i=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return!o.apply(void 0,p(t))}):(r=E(e),i=function(t){return!1===r.includes(I(t)?t[n]:t)}),Array.isArray(t))return t.filter(i)},t.arrayToggle=function(t,e,n){void 0===n&&(n=function(t,e){return t===e});var r=t.findIndex((function(t){return n(e,t)}));return~r?p(t.slice(0,r),t.slice(r+1)):p(t,[e])},t.arrayUpdate=fe,t.arrayUpsert=function(t,e,n,r){var i;void 0===r&&(r="id");var s=I(n);return t.some((function(t){return s?t[r]===e:t===e}))?fe(t,e,n,r):he(t,s?o({},n,((i={})[r]=e,i)):n)},t.byId=function(){return le("id")},t.byKey=le,t.cacheable=function(t,n,r){return void 0===r&&(r={emitNext:!1}),t._cache().value?r.emitNext?e.of(void 0):e.EMPTY:n},t.coerceArray=E,t.combineQueries=function(t){return e.combineLatest(t).pipe(n.auditTime(0))},t.commit=ht,t.compareValues=_t,t.configKey="akitaConfig",t.createEntityQuery=function(t,e){return void 0===e&&(e={}),new kt(t,e)},t.createEntityStore=function(t,e){return new bt(t,e)},t.createQuery=function(t){return new jt(t)},t.createStore=function(t,e){return new dt(t,e)},t.currentAction=f,t.dirtyCheckDefaultParams=Gt,t.dispatchAdded=Z,t.dispatchDeleted=G,t.dispatchUpdate=tt,t.distinctUntilArrayItemChanged=Et,t.enableAkitaProdMode=function(){t.__DEV__=!1,_&&(delete window.$$stores,delete window.$$queries)},t.endBatch=pt,t.entitiesToArray=At,t.entitiesToMap=Ot,t.filterNil=Tt,t.find=St,t.getActiveEntities=C,t.getAkitaConfig=z,t.getEntityStore=ce,t.getEntityStoreByName=pe,t.getExitingActives=R,t.getInitialEntitiesState=k,t.getNestedPath=Zt,t.getStore=ae,t.getStoreByName=ue,t.getValue=Ut,t.guid=function(){return Math.random().toString(36).slice(2)},t.hasActiveState=V,t.hasEntity=b,t.isArray=j,t.isDefined=x,t.isDev=w,t.isEmpty=U,t.isEntityState=$,t.isFunction=N,t.isMultiActiveState=D,t.isNil=S,t.isNotBrowser=A,t.isNumber=function(t){return!j(t)&&t-parseFloat(t)+1>=0},t.isObject=I,t.isPlainObject=rt,t.isString=wt,t.isTransactionInProcess=ft,t.isUndefined=F,t.logAction=y,t.persistState=function(t){var e={key:"AkitaStores",enableInNonBrowser:!1,storage:O()?localStorage:t.storage,deserialize:JSON.parse,serialize:JSON.stringify,include:[],select:[],persistOnDestroy:!1,preStorageUpdate:function(t,e){return e},preStoreUpdate:function(t,e){return e},skipStorageUpdate:Kt,preStorageUpdateOperator:function(){return function(t){return t}}},r=Object.assign({},e,t),i=r.storage,s=r.enableInNonBrowser,a=r.deserialize,u=r.serialize,c=r.include,p=r.select,f=r.key,h=r.preStorageUpdate,l=r.persistOnDestroy,y=r.preStorageUpdateOperator,v=r.preStoreUpdate,g=r.skipStorageUpdate;if((!A||s)&&i){var b,m,E=c.length>0,P=p.length>0;E&&(b=c.reduce((function(t,e){N(e)?t.fns.push(e):t[e.split(".")[0]]=e;return t}),{fns:[]})),P&&(m=p.reduce((function(t,e){return t[e.storeName]=e,t}),{}));var _={},w={},j=[],C=[],k=O()&&i===localStorage||function(){try{return"undefined"!=typeof sessionStorage}catch(t){return!1}}()&&i===sessionStorage;return Rt(i.getItem(f)).subscribe((function(t){var e=I(t)?t:a(t||"{}");function r(t){e.$cache=o({},e.$cache||{},t),e=Object.assign({},e,w),C.push(i.setItem(f,k?u(e):e)),function t(e){Rt(e).subscribe((function(){var e=C.shift();e&&t(e)}))}(C.shift())}function s(t,e){_[t]=it[t]._select((function(t){return Ut(t,e)})).pipe(n.skip(1),n.map((function(e){return P&&m[t]?m[t](e):e})),n.filter((function(){return!1===g()})),y()).subscribe((function(e){w[t]=h(t,e),Promise.resolve().then((function(){var e;return r(((e={})[t]=it[t]._cache().getValue(),e))}))}))}function c(t,n,r){if(t in e){d("@PersistState"),n._setState((function(n){return Nt(n,r,v(t,e[t],n))}));var i=!!e.$cache&&e.$cache[t];it[t].setHasCache(i,{restartTTL:!0})}}j.push(W.subscribe((function(t){var e;_[t]&&(!1===l&&r(((e={})[t]=!1,e)),_[t].unsubscribe(),delete _[t])}))),j.push(X.subscribe((function(t){if("router"!==t){var e=it[t];if(E){var n=b[t];if(!n){if(!b.fns.some((function(e){return e(t)})))return;n=t}c(t,e,n),s(t,n)}else c(t,e,t),s(t,t)}}))),Vt.next()})),{destroy:function(){j.forEach((function(t){return t.unsubscribe()}));for(var t=0,e=Object.keys(_);t<e.length;t++){var n=e[t];_[n].unsubscribe()}_={}},clear:function(){i.clear()},clearStore:function(t){S(t)?Rt(i.setItem(f,"{}")).subscribe():Rt(i.getItem(f)).subscribe((function(e){var n=a(e||"{}");n[t]&&(delete n[t],Rt(i.setItem(f,u(n))).subscribe())}))}}}},t.queryConfigKey="akitaQueryConfig",t.removeAllEntities=M,t.removeEntities=B,t.resetCustomAction=l,t.resetStores=function(t){t=Object.assign({},{exclude:[]},t);var e=Object.keys(it);lt((function(){var n,r;try{for(var i=u(e),o=i.next();!o.done;o=i.next()){var s=o.value,a=it[s];t.exclude?-1===t.exclude.indexOf(a.storeName)&&a.reset():a.reset()}}catch(t){n={error:t}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}}))},t.resolveActiveEntity=K,t.runEntityStoreAction=function(t,e,n){var r="string"==typeof t?pe(t):ce(t);n(r[se[e]].bind(r))},t.runStoreAction=function(t,e,n){var r="string"==typeof t?ue(t):ae(t);n(r[oe[e]].bind(r))},t.selectPersistStateInit=function(){return Vt.asObservable()},t.setAction=d,t.setEntities=q,t.setLoading=function(t){return function(r){return e.defer((function(){return t.setLoading(!0),r.pipe(n.finalize((function(){return t.setLoading(!1)})))}))}},t.setSkipAction=v,t.setValue=Nt,t.snapshotManager=Mt,t.sortByOptions=Ct,t.startBatch=ct,t.toBoolean=nt,t.toEntitiesIds=function(t,e){var n,r;void 0===e&&(e="id");var i=[];try{for(var o=u(t),s=o.next();!s.done;s=o.next()){var a=s.value;i.push(a[e])}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return i},t.toEntitiesObject=H,t.trackIdChanges=function(t){return function(e){return e.lift(new de(t))}},t.transaction=yt,t.transactionManager=ut,t.updateEntities=vt,t.withTransaction=function(t){return function(e){return e.pipe(n.tap((function(e){return lt((function(){return t(e)}))})))}},t.ɵa=_,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=datorama-akita.umd.min.js.map